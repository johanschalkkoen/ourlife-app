<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OurLife Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #1e293b;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      color: #f1f5f9;
    }
    .fc-event {
      position: relative;
      cursor: pointer;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      margin: 4px 6px;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }
    .fc-event:hover {
      transform: scale(1.03);
      background-color: rgba(255, 255, 255, 0.1);
    }
    .fc-event:active {
      transform: scale(0.98);
    }
    .fc-event-main {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
  P0+r\P0+r\P0+r\P0+r\P0+r\P0+r\P0+r\    padding: 8px;
      background: none;
      color: #f1f5f9;
      font-size: 0.875rem;
    }
    .fc-event-title {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
    }
    .fc-event-user {
      font-size: 0.75rem;
      opacity: 0.8;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modal {
      transform: scale(0.8);
      opacity: 0;
      transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }
    .modal.show {
      transform: scale(1);
      opacity: 1;
    }
    .profile-pic-container {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2dd4bf;
      background: #fff;
    }
    .profile-pic {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .event-profile-pic-container {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #fff;
      background: #fff;
    }
    .event-profile-pic {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    input, select, textarea {
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
      border-color: #2dd4bf;
    }
    button {
      transition: all 0.2s ease;
    }
    button:hover {
      transform: scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_BASE = 'https://ourlife.work.gd:8443/api';
    const DEFAULT_PROFILE_PIC = 'https://placehold.co/50x50/808080/FFFFFF?text=U';
    const DEFAULT_EVENT_COLOR = '#2dd4bf';
    const MONTHS = [
      { value: '01', label: 'January' }, { value: '02', label: 'February' },
      { value: '03', label: 'March' }, { value: '04', label: 'April' },
      { value: '05', label: 'May' }, { value: '06', label: 'June' },
      { value: '07', label: 'July' }, { value: '08', label: 'August' },
      { value: '09', label: 'September' }, { value: '10', label: 'October' },
      { value: '11', label: 'November' }, { value: '12', label: 'December' }
    ];
    const CURRENCY_CONFIG = {
      USD: { symbol: '$', rate: 1 },
      EUR: { symbol: 'â‚¬', rate: 0.85 },
      ZAR: { symbol: 'R', rate: 18.5 }
    };

    const capitalize = str => str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    const getCurrentDateTime = () => {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      return now.toISOString().slice(0, 19);
    };
    const formatDateTime = date => new Date(date).toLocaleString('en-ZA', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(/,/, '');
    const formatAmount = amount => `${CURRENCY_CONFIG.ZAR.symbol}${parseFloat(amount).toFixed(2)}`;

    const Input = ({ label, className = '', ...props }) => (
      <div>
        {label && <label className="block text-white text-lg font-medium mb-2">{label}</label>}
        <input className={`w-full p-3 rounded-lg bg-white/10 text-white placeholder-gray-400 border border-white/10 focus:outline-none focus:border-teal-400 ${className}`} {...props} />
      </div>
    );
    const Select = ({ label, options, className = '', ...props }) => (
      <div>
        {label && <label className="block text-white text-lg font-medium mb-2">{label}</label>}
        <select className={`w-full p-3 rounded-lg bg-white/10 text-white border border-white/10 focus:outline-none focus:border-teal-400 ${className}`} {...props}>
          {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label || opt.value}</option>)}
        </select>
      </div>
    );
    const Button = ({ children, className = 'bg-teal-500 hover:bg-teal-600', ...props }) => (
      <button className={`w-full p-3 text-white rounded-lg ${className}`} {...props}>{children}</button>
    );
    const ProfilePic = ({ src, username, size = '56px', border = '2px solid #2dd4bf' }) => (
      <div className="flex flex-col items-center">
        <div className="profile-pic-container" style={{ width: size, height: size, border }}>
          <img src={src || DEFAULT_PROFILE_PIC} alt={username} className="profile-pic" />
        </div>
        <span className="text-sm text-gray-300 mt-2">{username}</span>
      </div>
    );

    const useAccessibleUsers = (user, setUserProfiles) => {
      const [accessibleUsers, setAccessibleUsers] = useState([user.username]);
      const [selectedUsers, setSelectedUsers] = useState([user.username]);
      useEffect(() => {
        axios.get(`${API_BASE}/get-access`, { params: { viewer: user.username } })
          .then(({ data }) => {
            if (data.success) {
              const users = [user.username, ...data.accessList.filter(a => a.viewer === user.username).map(a => a.target)];
              setAccessibleUsers(users);
              setSelectedUsers(users);
              const profiles = { [user.username]: user.profilePicUrl || DEFAULT_PROFILE_PIC };
              Promise.all(users.filter(u => u !== user.username).map(u =>
                axios.get(`${API_BASE}/profile-pictures?username=${u}`)
                  .then(({ data }) => [u, data.profilePicUrl || DEFAULT_PROFILE_PIC])
                  .catch(() => [u, DEFAULT_PROFILE_PIC])
              )).then(results => setUserProfiles(Object.fromEntries(results.concat([[user.username, user.profilePicUrl || DEFAULT_PROFILE_PIC]]))));
            }
          })
          .catch(err => { console.error('Error fetching accessible users:', err); setAccessibleUsers([user.username]); setSelectedUsers([user.username]); });
      }, [user.username]);
      return { accessibleUsers, selectedUsers, setSelectedUsers };
    };

    const Login = ({ onLogin }) => {
      const [credentials, setCredentials] = useState({ username: '', password: '' });
      const [error, setError] = useState('');
      const handleChange = e => setCredentials({ ...credentials, [e.target.name]: e.target.value });
      const handleLogin = async e => {
        e.preventDefault();
        try {
          const { data } = await axios.post(`${API_BASE}/login`, credentials);
          if (data.success) {
            const { data: profile } = await axios.get(`${API_BASE}/profile-pictures?username=${credentials.username}`).catch(() => ({
              data: { profilePicUrl: DEFAULT_PROFILE_PIC, eventColor: DEFAULT_EVENT_COLOR }
            }));
            onLogin({
              username: credentials.username,
              profilePicUrl: profile.profilePicUrl || DEFAULT_PROFILE_PIC,
              eventColor: profile.eventColor || DEFAULT_EVENT_COLOR,
              email: profile.email || '',
              phone: profile.phone || '',
              address: profile.address || '',
              isAdmin: profile.isAdmin || false
            });
          } else {
            setError(data.message || 'Login failed.');
          }
        } catch (err) {
          setError('Error during login. Check server.');
          console.error('Login error:', err);
        }
      };
      return (
        <div className="flex items-center justify-center min-h-screen px-4">
          <div className="card p-8 w-full max-w-md">
            <h1 className="text-2xl font-semibold text-white mb-6 text-center">Sign In</h1>
            <form onSubmit={handleLogin} className="space-y-4">
              <Input name="username" placeholder="Username" value={credentials.username} onChange={handleChange} />
              <Input type="password" name="password" placeholder="Password" value={credentials.password} onChange={handleChange} />
              {error && <p className="text-red-400 text-sm text-center">{error}</p>}
              <Button type="submit">Sign In</Button>
            </form>
          </div>
        </div>
      );
    };

    const Menu = ({ user, setPage, onLogout }) => (
      <div className="flex items-center justify-center min-h-screen px-4">
        <div className="card p-8 w-full max-w-md">
          <h1 className="text-2xl font-semibold text-white mb-6 text-center flex items-center justify-center gap-3">
            <ProfilePic src={user.profilePicUrl} username={user.username} />
            <span>Welcome, {capitalize(user.username)}!</span>
          </h1>
          <div className="space-y-3">
            {['financial', 'calendar', 'profileSettings', ...(user.isAdmin ? ['admin'] : [])].map(page => (
              <Button key={page} onClick={() => setPage(page)}>{capitalize(page)}</Button>
            ))}
            <Button className="bg-red-500 hover:bg-red-600" onClick={onLogout}>Sign Out</Button>
          </div>
        </div>
      </div>
    );

    const ProfileSettings = ({ user, setPage, onLogout, setUser }) => {
      const [form, setForm] = useState({
        profilePicUrl: user.profilePicUrl || '',
        email: user.email || '',
        phone: user.phone || '',
        address: user.address || '',
        eventColor: user.eventColor || DEFAULT_EVENT_COLOR,
        currentPassword: '',
        newPassword: '',
        confirmNewPassword: ''
      });
      const [selectedFile, setSelectedFile] = useState(null);
      const [message, setMessage] = useState('');
      const [passwordMessage, setPasswordMessage] = useState('');
      const handleChange = e => setForm({ ...form, [e.target.name]: e.target.value });
      const handleFileChange = e => {
        const file = e.target.files[0];
        if (file) {
          if (!file.type.startsWith('image/')) {
            setMessage('Please select a valid image file (e.g., PNG, JPEG).');
            setSelectedFile(null);
            setForm({ ...form, profilePicUrl: user.profilePicUrl || DEFAULT_PROFILE_PIC });
            return;
          }
          if (file.size > 5 * 1024 * 1024) {
            setMessage('Image size must be less than 5MB.');
            setSelectedFile(null);
            setForm({ ...form, profilePicUrl: user.profilePicUrl || DEFAULT_PROFILE_PIC });
            return;
          }
          setSelectedFile(file);
          setMessage('');
          const reader = new FileReader();
          reader.onloadend = () => setForm({ ...form, profilePicUrl: reader.result });
          reader.readAsDataURL(file);
        } else {
          setSelectedFile(null);
          setForm({ ...form, profilePicUrl: user.profilePicUrl || DEFAULT_PROFILE_PIC });
        }
      };
      const handleSaveProfile = async () => {
        setMessage('Saving...');
        try {
          const urlToSave = selectedFile ? await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(selectedFile);
          }) : form.profilePicUrl || DEFAULT_PROFILE_PIC;
          if (urlToSave !== DEFAULT_PROFILE_PIC && !urlToSave.startsWith('data:image/')) {
            setMessage('Invalid image format. Please upload a valid image.');
            return;
          }
          const { data } = await axios.post(`${API_BASE}/profile-pictures`, {
            username: user.username, profilePicUrl: urlToSave, email: form.email, phone: form.phone, address: form.address, eventColor: form.eventColor
          });
          if (data.success) {
            setMessage('Profile saved successfully!');
            setUser({ ...user, profilePicUrl: urlToSave, email: form.email, phone: form.phone, address: form.address, eventColor: form.eventColor });
          } else {
            setMessage(data.message || 'Failed to save profile.');
            setForm({ ...form, profilePicUrl: user.profilePicUrl || DEFAULT_PROFILE_PIC });
          }
        } catch (err) {
          setMessage('Error saving profile. Please try again.');
          console.error('Error saving profile:', err);
          setForm({ ...form, profilePicUrl: user.profilePicUrl || DEFAULT_PROFILE_PIC });
        }
      };
      const handlePasswordChange = async () => {
        setPasswordMessage('');
        if (!form.currentPassword || !form.newPassword || !form.confirmNewPassword) return setPasswordMessage('All password fields are required.');
        if (form.newPassword !== form.confirmNewPassword) return setPasswordMessage('Passwords do not match.');
        if (form.newPassword.length < 6) return setPasswordMessage('Password must be at least 6 characters.');
        setPasswordMessage('Changing password...');
        try {
          const { data } = await axios.post(`${API_BASE}/update-password`, {
            username: user.username, currentPassword: form.currentPassword, newPassword: form.newPassword
          });
          setPasswordMessage(data.success ? 'Password updated successfully!' : data.message || 'Failed to update password.');
          if (data.success) setForm({ ...form, currentPassword: '', newPassword: '', confirmNewPassword: '' });
        } catch (err) {
          setPasswordMessage('Error updating password.');
          console.error('Error updating password:', err);
        }
      };
      return (
        <div className="p-6 max-w-4xl mx-auto">
          <div className="flex justify-between mb-6">
            <Button className="px-4 py-2 bg-gray-600 hover:bg-gray-700" onClick={() => setPage('menu')}>Back to Menu</Button>
            <Button className="px-4 py-2 bg-red-500 hover:bg-red-600" onClick={onLogout}>Sign Out</Button>
          </div>
          <div className="card p-8">
            <h1 className="text-2xl font-semibold text-white mb-6">Profile Settings</h1>
            <div className="space-y-6">
              <div>
                <label className="block text-white text-lg font-medium mb-2">Profile Picture</label>
                <div className="flex items-center gap-4 mb-4">
                  <div className="profile-pic-container">
                    <img src={form.profilePicUrl || DEFAULT_PROFILE_PIC} alt="Profile" className="profile-pic" />
                  </div>
                  <span className="text-white">{user.username}</span>
                </div>
                <Input type="file" accept="image/*" onChange={handleFileChange} className="file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-teal-500 file:text-white hover:file:bg-teal-600" />
              </div>
              <Input label="Email" type="email" name="email" placeholder="Enter your email" value={form.email} onChange={handleChange} />
              <Input label="Phone Number" type="tel" name="phone" placeholder="Enter your phone number" value={form.phone} onChange={handleChange} />
              <div>
                <label className="block text-white text-lg font-medium mb-2">Address</label>
                <textarea name="address" placeholder="Enter your address" value={form.address} onChange={handleChange} rows="3" className="w-full p-3 rounded-lg bg-white/10 text-white placeholder-gray-400 border border-white/10 focus:outline-none focus:border-teal-400"></textarea>
              </div>
              <Input label="Event Color" type="color" name="eventColor" value={form.eventColor} onChange={handleChange} className="h-12 cursor-pointer" />
              {message && <p className={`text-center text-sm ${message.includes('success') ? 'text-green-400' : 'text-red-400'}`}>{message}</p>}
              <Button onClick={handleSaveProfile}>Save Profile</Button>
              <div className="pt-6 border-t border-white/10">
                <h2 className="text-xl font-semibold text-white mb-4">Change Password</h2>
                <Input type="password" placeholder="Current Password" name="currentPassword" value={form.currentPassword} onChange={handleChange} className="mb-4" />
                <Input type="password" placeholder="New Password" name="newPassword" value={form.newPassword} onChange={handleChange} className="mb-4" />
                <Input type="password" placeholder="Confirm New Password" name="confirmNewPassword" value={form.confirmNewPassword} onChange={handleChange} className="mb-4" />
                {passwordMessage && <p className={`text-center text-sm ${passwordMessage.includes('success') ? 'text-green-400' : 'text-red-400'}`}>{passwordMessage}</p>}
                <Button onClick={handlePasswordChange}>Change Password</Button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const Financial = ({ user, setPage, onLogout }) => {
      const [items, setItems] = useState([]);
      const [form, setForm] = useState({ description: '', amount: '', type: 'income', date: getCurrentDateTime() });
      const [hideValues, setHideValues] = useState(false);
      const [selectedMonth, setSelectedMonth] = useState('07');
      const [netTotal, setNetTotal] = useState(0);
      const [bulkData, setBulkData] = useState('');
      const [importMessage, setImportMessage] = useState('');
      const [showAddItemForm, setShowAddItemForm] = useState(false);
      const [showImportTool, setShowImportTool] = useState(false);
      const { accessibleUsers, selectedUsers, setSelectedUsers } = useAccessibleUsers(user, profiles => setUserProfiles(profiles));
      const [userProfiles, setUserProfiles] = useState({ [user.username]: user.profilePicUrl });
      const fetchItems = () => axios.get(`${API_BASE}/financial`, { params: { user: user.username } }).then(({ data }) => setItems(data)).catch(err => console.error('Error fetching financial items:', err));
      const calculateNetTotal = () => {
        const total = items
          .filter(item => selectedUsers.includes(item.user) && item.date.startsWith(`2025-${selectedMonth}`))
          .reduce((sum, item) => item.type === 'income' ? sum + item.amount : sum - item.amount, 0);
        setNetTotal(total);
      };
      const addItem = async () => {
        if (!form.description || !form.amount || !form.date) return;
        const item = { user: user.username, description: form.description, amount: parseFloat(form.amount), type: form.type, date: form.date };
        try {
          await Promise.all([
            axios.post(`${API_BASE}/financial`, item),
            axios.post(`${API_BASE}/calendar`, { ...item, title: `${form.description} (${form.type})`, financial: true, eventColor: user.eventColor })
          ]);
          fetchItems();
          setForm({ description: '', amount: '', type: 'income', date: getCurrentDateTime() });
          setShowAddItemForm(false);
        } catch (err) {
          console.error('Error adding financial item:', err);
        }
      };
      const deleteItem = id => axios.delete(`${API_BASE}/financial/${id}`).then(fetchItems).catch(err => console.error('Error deleting financial item:', err));
      const handleBulkImport = async () => {
        if (!bulkData.trim()) return setImportMessage('Please paste data into the text box.');
        const itemsToImport = bulkData.trim().split('\n').filter(line => line.trim()).map(line => {
          const [description, amount, type, date] = line.split(',').map(field => field.trim());
          if (!description || !amount || !type || !date) return null;
          return { user: user.username, description, amount: parseFloat(amount), type, date };
        }).filter(Boolean);
        if (!itemsToImport.length) return setImportMessage('No valid data found. Please check the format.');
        setImportMessage(`Importing ${itemsToImport.length} items...`);
        try {
          await Promise.all(itemsToImport.map(item => Promise.all([
            axios.post(`${API_BASE}/financial`, item),
            axios.post(`${API_BASE}/calendar`, { ...item, title: `${item.description} (${item.type})`, financial: true, eventColor: user.eventColor })
          ])));
          setImportMessage(`Successfully imported ${itemsToImport.length} items!`);
          setBulkData('');
          setShowImportTool(false);
          fetchItems();
        } catch (err) {
          setImportMessage('An error occurred during import. Please check the data and try again.');
          console.error('Bulk import error:', err);
        }
      };
      useEffect(() => { fetchItems(); }, [selectedUsers]);
      useEffect(() => { calculateNetTotal(); }, [items, selectedUsers, selectedMonth]);
      return (
        <div className="p-6 max-w-4xl mx-auto">
          <div className="flex justify-between mb-6">
            <Button className="px-4 py-2 bg-gray-600 hover:bg-gray-700" onClick={() => setPage('menu')}>Back to Menu</Button>
            <Button className="px-4 py-2 bg-red-500 hover:bg-red-600" onClick={onLogout}>Sign Out</Button>
          </div>
          <div className="card p-8">
            <div className="flex flex-col sm:flex-row justify-between items-center mb-6">
              <h1 className="text-2xl font-semibold text-white flex items-center gap-3">
                <ProfilePic src={user.profilePicUrl} username={user.username} />
                <span>Finances</span>
              </h1>
              <div className="flex space-x-3 mt-4 sm:mt-0">
                <Select options={MONTHS.map(m => ({ ...m, label: `${m.label} 2025` }))} value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} />
                <Button className="px-4 py-2 bg-blue-500 hover:bg-blue-600" onClick={() => setShowAddItemForm(!showAddItemForm)}>{showAddItemForm ? 'Hide Form' : 'Add Item'}</Button>
                <Button className="px-4 py-2 bg-green-500 hover:bg-green-600" onClick={() => setShowImportTool(!showImportTool)}>{showImportTool ? 'Hide Import' : 'Bulk Import'}</Button>
              </div>
            </div>
            <div className="card p-6 mb-6">
              <h2 className="text-xl font-semibold text-white mb-2">Net Total for {MONTHS.find(m => m.value === selectedMonth)?.label} 2025</h2>
              <p className={`text-2xl font-bold ${netTotal >= 0 ? 'text-green-400' : 'text-red-400'}`}>{hideValues ? '****' : formatAmount(netTotal)}</p>
            </div>
            <div className="mb-6">
              <h3 className="text-lg font-medium text-white mb-3">View Data For:</h3>
              <div className="flex flex-wrap gap-2">
                {accessibleUsers.map(username => (
                  <Button key={username} className={selectedUsers.includes(username) ? 'px-3 py-2 bg-teal-500 hover:bg-teal-600' : 'px-3 py-2 bg-gray-600 hover:bg-gray-700'} onClick={() => setSelectedUsers(prev => prev.includes(username) ? prev.filter(u => u !== username) : [...prev, username])}>{username}</Button>
                ))}
              </div>
            </div>
            {showImportTool && (
              <div className="card p-6 mb-6 space-y-4">
                <h2 className="text-xl font-semibold text-white">Bulk Import Tool</h2>
                <p className="text-gray-300 text-sm">Paste your data here in CSV format: Description,Amount,Type,Date (YYYY-MM-DD HH:mm:ss)</p>
                <textarea placeholder="e.g., Salary,50000,income,2025-07-25 14:30:00" value={bulkData} onChange={e => setBulkData(e.target.value)} rows="8" className="w-full p-3 rounded-lg bg-white/10 text-white placeholder-gray-400 border border-white/10 focus:outline-none focus:border-teal-400" />
                <Button className="bg-green-600 hover:bg-green-700" onClick={handleBulkImport}>Import Pasted Data</Button>
                {importMessage && <p className={`text-center text-sm ${importMessage.includes('success') ? 'text-green-400' : 'text-red-400'}`}>{importMessage}</p>}
              </div>
            )}
            {showAddItemForm && (
              <div className="card p-6 mb-6 space-y-4">
                <h2 className="text-xl font-semibold text-white">Add Financial Item</h2>
                <Input name="description" placeholder="Description" value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} />
                <Input type="number" name="amount" placeholder="Amount (in ZAR)" value={form.amount} onChange={e => setForm({ ...form, amount: e.target.value })} />
                <Select name="type" value={form.type} onChange={e => setForm({ ...form, type: e.target.value })} options={[{ value: 'income', label: 'Income' }, { value: 'expense', label: 'Expense' }]} />
                <Input type="datetime-local" name="date" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })} step="1" />
                <Button onClick={addItem}>Add Item</Button>
              </div>
            )}
            <div className="space-y-4 mb-6">
              <Button onClick={() => setHideValues(!hideValues)}>{hideValues ? 'Show Values' : 'Hide Values'}</Button>
            </div>
            <div className="space-y-3">
              {items.filter(item => selectedUsers.includes(item.user) && item.date.startsWith(`2025-${selectedMonth}`)).map(item => (
                <div key={item.id} className="flex justify-between p-4 card items-center">
                  <div className="flex items-center gap-3">
                    <div className="event-profile-pic-container"><img src={userProfiles[item.user] || DEFAULT_PROFILE_PIC} alt={item.user} className="event-profile-pic" /></div>
                    <span>{item.description} ({item.type}) - {formatDateTime(item.date)} ({item.user})</span>
                  </div>
                  <div className="flex items-center gap-3">
                    <span>{hideValues ? '****' : formatAmount(item.amount)}</span>
                    {item.user === user.username && <Button className="px-3 py-1 bg-red-500 hover:bg-red-600" onClick={() => deleteItem(item.id)}>Delete</Button>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const Calendar = ({ user, setPage, onLogout }) => {
      const [events, setEvents] = useState([]);
      const [form, setForm] = useState({ title: '', date: getCurrentDateTime(), financial: false, amount: '', category: 'income' });
      const [selectedMonth, setSelectedMonth] = useState('07');
      const [showAddEventForm, setShowAddEventForm] = useState(false);
      const [showModal, setShowModal] = useState(false);
      const [selectedEvent, setSelectedEvent] = useState(null);
      const { accessibleUsers, selectedUsers, setSelectedUsers } = useAccessibleUsers(user, profiles => setUserProfiles(profiles));
      const [userProfiles, setUserProfiles] = useState({ [user.username]: user.profilePicUrl || DEFAULT_PROFILE_PIC });
      const calendarRef = useRef(null);
      const fullCalendarInstance = useRef(null);
      const fetchEvents = () => axios.get(`${API_BASE}/calendar`, { params: { user: user.username } })
        .then(({ data }) => setEvents(data.map(e => ({
          id: e.id, title: e.title, start: e.date, user: e.user, financial: e.financial, type: e.type, amount: e.amount, eventColor: e.eventColor || DEFAULT_EVENT_COLOR
        }))))
        .catch(err => console.error('Error fetching calendar events:', err));
      const handleAddEvent = async () => {
        if (!form.title || !form.date) return alert('Event title and date are required!');
        try {
          const eventData = {
            user: user.username, title: form.title, date: form.date, financial: form.financial,
            type: form.financial ? form.category : undefined, amount: form.financial ? parseFloat(form.amount) : undefined, eventColor: user.eventColor
          };
          await Promise.all([
            axios.post(`${API_BASE}/calendar`, eventData),
            form.financial && axios.post(`${API_BASE}/financial`, { user: user.username, description: form.title, amount: parseFloat(form.amount), type: form.category, date: form.date })
          ].filter(Boolean));
          fetchEvents();
          setForm({ title: '', date: getCurrentDateTime(), financial: false, amount: '', category: 'income' });
          setShowAddEventForm(false);
        } catch (err) {
          alert('Failed to add event.');
          console.error('Error adding event:', err);
        }
      };
      const handleDeleteEvent = id => axios.delete(`${API_BASE}/calendar/${id}`).then(() => { fetchEvents(); setShowModal(false); setSelectedEvent(null); }).catch(err => { alert('Failed to delete event.'); console.error('Error deleting event:', err); });
      useEffect(() => {
        fetchEvents();
        const calendarEl = calendarRef.current;
        if (calendarEl && !fullCalendarInstance.current) {
          fullCalendarInstance.current = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: `2025-${selectedMonth}-01`,
            editable: true,
            selectable: true,
            events: events.filter(e => selectedUsers.includes(e.user)),
            eventContent: ({ event }) => {
              const eventEl = document.createElement('div');
              eventEl.className = 'fc-event-main';
              eventEl.style.backgroundColor = event.extendedProps.eventColor;
              eventEl.style.opacity = '0.8';
              const imgEl = document.createElement('img');
              imgEl.src = userProfiles[event.extendedProps.user] || DEFAULT_PROFILE_PIC;
              imgEl.alt = event.extendedProps.user;
              imgEl.className = 'event-profile-pic';
              const titleSpan = document.createElement('span');
              titleSpan.className = 'fc-event-title';
              titleSpan.textContent = event.title;
              const userSpan = document.createElement('span');
              userSpan.className = 'fc-event-user';
              userSpan.textContent = event.extendedProps.user;
              const eventPicContainer = document.createElement('div');
              eventPicContainer.className = 'event-profile-pic-container';
              eventPicContainer.appendChild(imgEl);
              eventEl.appendChild(eventPicContainer);
              eventEl.appendChild(titleSpan);
              eventEl.appendChild(userSpan);
              return { domNodes: [eventEl] };
            },
            eventClick: ({ event }) => {
              setSelectedEvent({
                id: event.id, title: event.title, date: event.start.toISOString().slice(0, 19), user: event.extendedProps.user,
                financial: event.extendedProps.financial, type: event.extendedProps.type, amount: event.extendedProps.amount,
                profilePicUrl: userProfiles[event.extendedProps.user] || DEFAULT_PROFILE_PIC, eventColor: event.extendedProps.eventColor
              });
              setShowModal(true);
            },
            select: () => { setForm({ ...form, date: getCurrentDateTime() }); setShowAddEventForm(true); }
          });
          fullCalendarInstance.current.render();
        }
        return () => { if (fullCalendarInstance.current) { fullCalendarInstance.current.destroy(); fullCalendarInstance.current = null; } };
      }, [userProfiles]);
      useEffect(() => { if (fullCalendarInstance.current) fullCalendarInstance.current.gotoDate(`2025-${selectedMonth}-01`); }, [selectedMonth]);
      useEffect(() => { if (fullCalendarInstance.current) fullCalendarInstance.current.setOption('events', events.filter(e => selectedUsers.includes(e.user))); }, [events, selectedUsers]);
      return (
        <div className="p-6 max-w-6xl mx-auto">
          <div className="flex justify-between mb-6">
            <Button className="px-4 py-2 bg-gray-600 hover:bg-gray-700" onClick={() => setPage('menu')}>Back to Menu</Button>
            <Button className="px-4 py-2 bg-red-500 hover:bg-red-600" onClick={onLogout}>Sign Out</Button>
          </div>
          <div className="card p-8">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-2xl font-semibold text-white flex items-center gap-3">
                <ProfilePic src={user.profilePicUrl} username={user.username} />
                <span>Calendar</span>
              </h1>
              <div className="flex space-x-3">
                <Select options={MONTHS.map(m => ({ ...m, label: `${m.label} 2025` }))} value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} />
                <Button className="px-4 py-2" onClick={() => setShowAddEventForm(!showAddEventForm)}>{showAddEventForm ? 'Hide Form' : 'Add Event'}</Button>
              </div>
            </div>
            <div className="mb-6">
              <h3 className="text-lg font-medium text-white mb-3">View Data For:</h3>
              <div className="flex flex-wrap gap-2">
                {accessibleUsers.map(username => (
                  <Button key={username} className={selectedUsers.includes(username) ? 'px-3 py-2 bg-teal-500 hover:bg-teal-600' : 'px-3 py-2 bg-gray-600 hover:bg-gray-700'} onClick={() => setSelectedUsers(prev => prev.includes(username) ? prev.filter(u => u !== username) : [...prev, username])}>{username}</Button>
                ))}
              </div>
            </div>
            {showAddEventForm && (
              <div className="card p-6 mb-6 space-y-4">
                <h2 className="text-xl font-semibold text-white">Add Calendar Event</h2>
                <Input placeholder="Event Title" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })} />
                <Input type="datetime-local" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })} step="1" />
                <div className="flex items-center space-x-2">
                  <input type="checkbox" id="isFinancial" checked={form.financial} onChange={e => setForm({ ...form, financial: e.target.checked })} className="form-checkbox h-5 w-5 text-teal-500 rounded" />
                  <label htmlFor="isFinancial" className="text-white">Financial Event?</label>
                </div>
                {form.financial && (
                  <div className="space-y-4">
                    <Input type="number" placeholder="Amount (in ZAR)" value={form.amount} onChange={e => setForm({ ...form, amount: e.target.value })} />
                    <Select value={form.category} onChange={e => setForm({ ...form, category: e.target.value })} options={[{ value: 'income', label: 'Income' }, { value: 'expense', label: 'Expense' }]} />
                  </div>
                )}
                <Button onClick={handleAddEvent}>Add Event</Button>
              </div>
            )}
            <div id="calendar" ref={calendarRef} className="text-white"></div>
            {showModal && selectedEvent && (
              <div className="fixed inset-0 flex items-center justify-center bg-black/50 z-50" onClick={() => { setShowModal(false); setTimeout(() => setSelectedEvent(null), 300); }}>
                <div className={`modal card p-8 max-w-md w-full mx-4 ${showModal ? 'show' : ''}`} style={{ backgroundColor: selectedEvent.eventColor, opacity: 0.8 }} onClick={e => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-semibold text-white">Event Details</h2>
                    <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-white">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div className="space-y-4">
                    <div className="flex items-center gap-3">
                      <div className="event-profile-pic-container !w-10 !h-10"><img src={selectedEvent.profilePicUrl} alt={selectedEvent.user} className="event-profile-pic" /></div>
                      <span className="text-lg font-semibold text-white">{selectedEvent.title}</span>
                    </div>
                    <p className="text-white"><strong>Date:</strong> {formatDateTime(selectedEvent.date)}</p>
                    <p className="text-white"><strong>User:</strong> {selectedEvent.user}</p>
                    {selectedEvent.financial ? (
                      <>
                        <p className="text-white"><strong>Type:</strong> {selectedEvent.type}</p>
                        <p className="text-white"><strong>Amount:</strong> R{selectedEvent.amount.toFixed(2)}</p>
                      </>
                    ) : <p className="text-white">Non-financial event</p>}
                    {selectedEvent.user === user.username && <Button className="bg-red-500 hover:bg-red-600" onClick={() => handleDeleteEvent(selectedEvent.id)}>Delete Event</Button>}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const Admin = ({ user, setPage, onLogout }) => {
      const [users, setUsers] = useState([]);
      const [pamComparison, setPamComparison] = useState(null);
      const [accessList, setAccessList] = useState([]);
      const [form, setForm] = useState({ newUsername: '', newPassword: '', confirmNewPassword: '', selectedUser: '', updatePassword: '', updateConfirmPassword: '', accessViewer: '', accessTarget: '', adminUser: '' });
      const [messages, setMessages] = useState({ add: '', update: '', access: '', admin: '' });
      const fetchData = (endpoint, setter, key = 'data') => axios.get(`${API_BASE}/${endpoint}`)
        .then(({ data }) => setter(data.success ? data[key] || data : []))
        .catch(err => { setMessages(prev => ({ ...prev, [key === 'data' ? endpoint : key]: `Error fetching ${key}.` })); console.error(`Error fetching ${key}:`, err); });
      useEffect(() => {
        fetchData('users', setUsers);
        fetchData('pam-users', setPamComparison, 'pamComparison');
        fetchData('get-access', setAccessList, 'accessList');
      }, []);
      const handleAddUser = async e => {
        e.preventDefault();
        const { newUsername, newPassword, confirmNewPassword } = form;
        if (!newUsername || !newPassword || !confirmNewPassword) return setMessages({ ...messages, add: 'All fields are required.' });
        if (newPassword !== confirmNewPassword) return setMessages({ ...messages, add: 'Passwords do not match.' });
        if (newPassword.length < 6) return setMessages({ ...messages, add: 'Password must be at least 6 characters.' });
        try {
          const { data } = await axios.post(`${API_BASE}/add-user`, { username: newUsername, password: newPassword });
          setMessages({ ...messages, add: data.success ? 'User added successfully!' : data.message || 'Failed to add user.' });
          if (data.success) {
            setForm({ ...form, newUsername: '', newPassword: '', confirmNewPassword: '' });
            fetchData('users', setUsers);
            fetchData('pam-users', setPamComparison, 'pamComparison');
          }
        } catch (err) {
          setMessages({ ...messages, add: 'Error adding user.' });
          console.error('Error adding user:', err);
        }
      };
      const handleDeleteUser = async username => {
        if (username === user.username) return setMessages({ ...messages, add: 'Cannot delete your own account.' });
        if (!confirm(`Delete user ${username}?`)) return;
        try {
          const { data } = await axios.delete(`${API_BASE}/delete-user/${username}`);
          setMessages({ ...messages, add: data.success ? 'User deleted successfully!' : data.message || 'Failed to delete user.' });
          if (data.success) {
            fetchData('users', setUsers);
            fetchData('pam-users', setPamComparison, 'pamComparison');
            fetchData('get-access', setAccessList, 'accessList');
          }
        } catch (err) {
          setMessages({ ...messages, add: 'Error deleting user.' });
          console.error('Error deleting user:', err);
        }
      };
      const handleUpdatePassword = async e => {
        e.preventDefault();
        const { selectedUser, updatePassword, updateConfirmPassword } = form;
        if (!selectedUser) return setMessages({ ...messages, update: 'Please select a user.' });
        if (selectedUser === user.username) return setMessages({ ...messages, update: 'Use Profile Settings to update your own password.' });
        if (!updatePassword || !updateConfirmPassword) return setMessages({ ...messages, update: 'New password and confirmation are required.' });
        if (updatePassword !== updateConfirmPassword) return setMessages({ ...messages, update: 'Passwords do not match.' });
        if (updatePassword.length < 6) return setMessages({ ...messages, update: 'Password must be at least 6 characters.' });
        try {
          const { data } = await axios.post(`${API_BASE}/admin-update-password`, { username: selectedUser, newPassword: updatePassword });
          setMessages({ ...messages, update: data.success ? `Password updated for ${selectedUser}!` : data.message || 'Failed to update password.' });
          if (data.success) setForm({ ...form, selectedUser: '', updatePassword: '', updateConfirmPassword: '' });
        } catch (err) {
          setMessages({ ...messages, update: 'Error updating password.' });
          console.error('Error updating password:', err);
        }
      };
      const handleGrantAccess = async e => {
        e.preventDefault();
        const { accessViewer, accessTarget } = form;
        if (!accessViewer || !accessTarget) return setMessages({ ...messages, access: 'Select both a viewer and target user.' });
        if (accessViewer === accessTarget) return setMessages({ ...messages, access: 'Cannot grant access to self.' });
        try {
          const { data } = await axios.post(`${API_BASE}/grant-access`, { viewer: accessViewer, target: accessTarget });
          setMessages({ ...messages, access: data.success ? data.message : data.message || 'Failed to grant access.' });
          if (data.success) {
            setForm({ ...form, accessViewer: '', accessTarget: '' });
            fetchData('get-access', setAccessList, 'accessList');
          }
        } catch (err) {
          setMessages({ ...messages, access: 'Error granting access.' });
          console.error('Error granting access:', err);
        }
      };
      const handleRevokeAccess = async (viewer, target) => {
        if (!confirm(`Revoke access for ${viewer} to view ${target}'s data?`)) return;
        try {
          const { data } = await axios.post(`${API_BASE}/revoke-access`, { viewer, target });
          setMessages({ ...messages, access: data.success ? data.message : data.message || 'Failed to revoke access.' });
          if (data.success) fetchData('get-access', setAccessList, 'accessList');
        } catch (err) {
          setMessages({ ...messages, access: 'Error revoking access.' });
          console.error('Error revoking access:', err);
        }
      };
      const handleAdminAction = async (action) => {
        if (!form.adminUser) return setMessages({ ...messages, admin: 'Please select a user.' });
        if (form.adminUser === user.username) return setMessages({ ...messages, admin: 'Cannot modify your own admin status.' });
        try {
          const { data } = await axios.post(`${API_BASE}/${action}-admin`, { username: form.adminUser });
          setMessages({ ...messages, admin: data.success ? `Admin access ${action}d for ${form.adminUser}!` : data.message || `Failed to ${action} admin access.` });
          if (data.success) {
            setForm({ ...form, adminUser: '' });
            fetchData('users', setUsers);
          }
        } catch (err) {
          setMessages({ ...messages, admin: `Error ${action}ing admin access.` });
          console.error(`Error ${action}ing admin access:`, err);
        }
      };
      return (
        <div className="p-6 max-w-4xl mx-auto">
          <div className="flex justify-between mb-6">
            <Button className="px-4 py-2 bg-gray-600 hover:bg-gray-700" onClick={() => setPage('menu')}>Back to Menu</Button>
            <Button className="px-4 py-2 bg-red-500 hover:bg-red-600" onClick={onLogout}>Sign Out</Button>
          </div>
          <div className="card p-8">
            <h1 className="text-2xl font-semibold text-white mb-6">Admin Panel</h1>
            <div className="space-y-8">
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">Add New User</h2>
                <form onSubmit={handleAddUser} className="space-y-4">
                  <Input placeholder="New Username" value={form.newUsername} onChange={e => setForm({ ...form, newUsername: e.target.value })} />
                  <Input type="password" placeholder="Password" value={form.newPassword} onChange={e => setForm({ ...form, newPassword: e.target.value })} />
                  <Input type="password" placeholder="Confirm Password" value={form.confirmNewPassword} onChange={e => setForm({ ...form, confirmNewPassword: e.target.value })} />
                  <Button type="submit">Add User</Button>
                </form>
                {messages.add && <p className={`mt-3 text-center text-sm ${messages.add.includes('success') ? 'text-green-400' : 'text-red-400'}`}>{messages.add}</p>}
              </div>
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">Manage Users</h2>
                <div className="space-y-3">
                  {users.map(u => (
                    <div key={u.username} className="flex justify-between items-center p-4 card">
                      <span>{u.username} {u.isAdmin ? '(Admin)' : ''}</span>
                      <Button className="px-3 py-1 bg-red-500 hover:bg-red-600" onClick={() => handleDeleteUser(u.username)}>Delete</Button>
                    </div>
                  ))}
                </div>
              </div>
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">Update User Password</h2>
                <form onSubmit={handleUpdatePassword} className="space-y-4">
                  <Select value={form.selectedUser} onChange={e => setForm({ ...form, selectedUser: e.target.value })} options={[{ value: '', label: 'Select User' }, ...users.map(u => ({ value: u.username, label: u.username }))]} />
                  <Input type="password" placeholder="New Password" value={form.updatePassword} onChange={e => setForm({ ...form, updatePassword: e.target.value })} />
                  <Input type="password" placeholder="Confirm New Password" value={form.updateConfirmPassword} onChange={e => setForm({ ...form, updateConfirmPassword: e.target.value })} />
                  <Button type="submit">Update Password</Button>
                </form>
                {messages.update && <p className={`mt-3 text-center text-sm ${messages.update.includes('success') ? 'text-green-400' : 'text-red-400'}`}>{messages.update}</p>}
              </div>
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">Manage Admin Access</h2>
                <div className="space-y-4">
                  <Select value={form.adminUser} onChange={e => setForm({ ...form, adminUser: e.target.value })} options={[{ value: '', label: 'Select User' }, ...users.map(u => ({ value: u.username, label: u.username }))]} />
                  <div className="flex space-x-3">
                    <Button onClick={() => handleAdminAction('grant')}>Grant Admin Access</Button>
                    <Button className="bg-red-500 hover:bg-red-600" onClick={() => handleAdminAction('revoke')}>Revoke Admin Access</Button>
                  </div>
                  {messages.admin && <p className={`mt-3 text-center text-sm ${messages.admin.includes('success') || messages.admin.includes('granted') || messages.admin.includes('revoked') ? 'text-green-400' : 'text-red-400'}`}>{messages.admin}</p>}
                </div>
              </div>
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">Manage User Access</h2>
                <form onSubmit={handleGrantAccess} className="space-y-4 mb-6">
                  <Select value={form.accessViewer} onChange={e => setForm({ ...form, accessViewer: e.target.value })} options={[{ value: '', label: 'Select Viewer' }, ...users.map(u => ({ value: u.username, label: u.username }))]} />
                  <Select value={form.accessTarget} onChange={e => setForm({ ...form, accessTarget: e.target.value })} options={[{ value: '', label: 'Select Target User' }, ...users.map(u => ({ value: u.username, label: u.username }))]} />
                  <Button type="submit">Grant Access</Button>
                </form>
                <h3 className="text-lg font-medium text-white mb-3">Current Access Permissions</h3>
                <div className="space-y-3">
                  {accessList.length ? accessList.map((access, index) => (
                    <div key={index} className="flex justify-between items-center p-4 card">
                      <span>{access.viewer} can view {access.target}'s data</span>
                      <Button className="px-3 py-1 bg-red-500 hover:bg-red-600" onClick={() => handleRevokeAccess(access.viewer, access.target)}>Revoke</Button>
                    </div>
                  )) : <p className="text-white">No access permissions set.</p>}
                </div>
                {messages.access && <p className={`mt-3 text-center text-sm ${messages.access.includes('success') || messages.access.includes('granted') || messages.access.includes('revoked') ? 'text-green-400' : 'text-red-400'}`}>{messages.access}</p>}
              </div>
              <div>
                <h2 className="text-xl font-semibold text-white mb-4">PAM User Comparison</h2>
                {pamComparison ? (
                  <div className="space-y-2 text-white">
                    {['pamUsers', 'appUsers', 'commonUsers', 'appOnlyUsers', 'pamOnlyUsers'].map(key => (
                      <p key={key}><strong>{capitalize(key.replace(/([A-Z])/g, ' $1'))}:</strong> {pamComparison[key].join(', ') || 'None'}</p>
                    ))}
                  </div>
                ) : <p className="text-white">Loading PAM comparison...</p>}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [page, setPage] = useState('login');
      const [user, setUser] = useState(null);
      return (
        <div>
          {page === 'login' && <Login onLogin={user => { setUser(user); setPage('menu'); }} />}
          {page === 'menu' && user && <Menu user={user} setPage={setPage} onLogout={() => { setUser(null); setPage('login'); }} />}
          {page === 'financial' && user && <Financial user={user} setPage={setPage} onLogout={() => { setUser(null); setPage('login'); }} />}
          {page === 'calendar' && user && <Calendar user={user} setPage={setPage} onLogout={() => { setUser(null); setPage('login'); }} />}
          {page === 'profileSettings' && user && <ProfileSettings user={user} setPage={setPage} onLogout={() => { setUser(null); setPage('login'); }} setUser={setUser} />}
          {page === 'admin' && user && user.isAdmin && <Admin user={user} setPage={setPage} onLogout={() => { setUser(null); setPage('login'); }} />}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
